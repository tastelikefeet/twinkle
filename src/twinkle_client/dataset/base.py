# ============================================================================
# WARNING: AUTO-GENERATED FILE - DO NOT MODIFY MANUALLY!
# ============================================================================
# This file is automatically generated by client_tools/client_generator.py
# Any manual changes will be overwritten when the generator runs again.
#
# To update this file:
#   1. Modify the source files in src/twinkle/
#   2. Run: python client_tools/client_generator.py
# ============================================================================

from typing import Any, Callable, Dict, Type, Union
from twinkle_client.http import http_post, heartbeat_manager
from twinkle.dataset import Dataset
from twinkle.dataset import DatasetMeta
from twinkle.preprocessor import DataFilter
from twinkle.preprocessor import Preprocessor
from twinkle.template import Template

class Dataset(object):
    """Client wrapper for Dataset that calls server HTTP endpoints."""

    def __init__(self, dataset_meta: DatasetMeta, **kwargs):
        from twinkle_client.http import get_base_url
        self.server_url = get_base_url()

        response = http_post(
            url=f'{self.server_url}/processors/create',
            json_data={
                'processor_type': 'dataset',
                'class_type': 'Dataset',
                **{'dataset_meta': dataset_meta}, **kwargs
            }
        )
        response.raise_for_status()
        self.processor_id = response.json()['processor_id']
        heartbeat_manager.register_processor(self.processor_id)

    def __del__(self):
        try:
            heartbeat_manager.unregister_processor(self.processor_id)
        except:
            pass

    
    def set_template(self, template_func: Union[Template, Type[Template], str], **kwargs):
        response = http_post(
            url=f'{self.server_url}/processors/call',
            json_data={
                'processor_id': self.processor_id,
                'function': 'set_template',
                **{'template_func': template_func},
                **kwargs
            }
        )
        response.raise_for_status()
        return response.json()["result"]
    

    def encode(self, add_generation_prompt: bool = False, **kwargs):
        response = http_post(
            url=f'{self.server_url}/processors/call',
            json_data={
                'processor_id': self.processor_id,
                'function': 'encode',
                **{'add_generation_prompt': add_generation_prompt},
                **kwargs
            }
        )
        response.raise_for_status()
        return response.json()["result"]
    

    def check(self, **kwargs):
        response = http_post(
            url=f'{self.server_url}/processors/call',
            json_data={
                'processor_id': self.processor_id,
                'function': 'check',
                **{},
                **kwargs
            }
        )
        response.raise_for_status()
        return response.json()["result"]
    

    def map(self, preprocess_func: Union[Preprocessor, Callable, str, Type[Preprocessor]], dataset_meta: DatasetMeta = None, init_args: Dict[str, Any] = None, **kwargs):
        response = http_post(
            url=f'{self.server_url}/processors/call',
            json_data={
                'processor_id': self.processor_id,
                'function': 'map',
                **{'preprocess_func': preprocess_func, 'dataset_meta': dataset_meta, 'init_args': init_args},
                **kwargs
            }
        )
        response.raise_for_status()
        return response.json()["result"]
    

    def filter(self, filter_func: Union[Callable, str, Type[DataFilter], DataFilter], dataset_meta: DatasetMeta = None, init_args: Dict[str, Any] = None, **kwargs):
        response = http_post(
            url=f'{self.server_url}/processors/call',
            json_data={
                'processor_id': self.processor_id,
                'function': 'filter',
                **{'filter_func': filter_func, 'dataset_meta': dataset_meta, 'init_args': init_args},
                **kwargs
            }
        )
        response.raise_for_status()
        return response.json()["result"]
    

    def add_dataset(self, dataset_meta: DatasetMeta, **kwargs):
        response = http_post(
            url=f'{self.server_url}/processors/call',
            json_data={
                'processor_id': self.processor_id,
                'function': 'add_dataset',
                **{'dataset_meta': dataset_meta},
                **kwargs
            }
        )
        response.raise_for_status()
        return response.json()["result"]
    

    def mix_dataset(self, interleave = True):
        response = http_post(
            url=f'{self.server_url}/processors/call',
            json_data={
                'processor_id': self.processor_id,
                'function': 'mix_dataset',
                **{'interleave': interleave},
            }
        )
        response.raise_for_status()
        return response.json()["result"]
    

    def __getitem__(self, idx):
        response = http_post(
            url=f'{self.server_url}/processors/call',
            json_data={
                'processor_id': self.processor_id,
                'function': '__getitem__',
                **{'idx': idx},
            }
        )
        response.raise_for_status()
        return response.json()["result"]
    

    def __len__(self):
        response = http_post(
            url=f'{self.server_url}/processors/call',
            json_data={
                'processor_id': self.processor_id,
                'function': '__len__',
                **{},
            }
        )
        response.raise_for_status()
        return response.json()["result"]
    